#!/bin/bash

# Brewfile hash: {{ includeTemplate "dot_Brewfile.tmpl" . | sha256sum }}
# This script re-runs if your Brewfile changes.

# --- 1. Bootstrap PATH ---
# Ensure Homebrew and language managers are in PATH for this session
if [[ "$(uname -m)" == "arm64" ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
else
    eval "$(/usr/local/bin/brew shellenv)"
fi
export PATH="$HOME/.pyenv/bin:$HOME/.goenv/bin:$HOME/.cargo/bin:$PATH"

# --- 2. Homebrew Bundle (macOS only) ---
{{ if eq .chezmoi.os "darwin" -}}
if command -v brew >/dev/null 2>&1; then
    echo "ğŸº Running Homebrew Bundle..."
    # Using --global assumes your Brewfile is at ~/.Brewfile
    # If it's in the repo, use: --file={{ joinPath .chezmoi.sourceDir "dot_Brewfile" | quote }}
    brew bundle --global
fi
{{ end -}}

# --- 3. Language Setup (Opt-in) ---
{{ if .install_languages -}}
echo "ğŸš€ Opt-in: Installing programming languages..."

# 3a. Rustup
if ! command -v rustup >/dev/null 2>&1; then
    echo "ğŸ¦€ Installing Rustup..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y &> /dev/null
fi

# 3b. Pyenv
if command -v pyenv >/dev/null 2>&1; then
    echo "ğŸ Setting up Python via pyenv..."
    eval "$(pyenv init -)"
    if ! pyenv versions --bare | grep -q "3.12"; then
         echo "Installing Python 3.12 (this may take a few minutes)..."
         pyenv install 3.12 &> /dev/null
         pyenv global 3.12
    fi
fi

# 3c. Goenv
if command -v goenv >/dev/null 2>&1; then
    echo "ğŸ¹ Initializing goenv..."
    eval "$(goenv init -)"
    # Optional: pyenv-style install logic can go here
fi

echo "âœ… Language managers initialized."

{{ else -}}
echo "â­ï¸ Skipping language installation as per config."
{{- end }}

echo "âœ… Package installation and setup complete."