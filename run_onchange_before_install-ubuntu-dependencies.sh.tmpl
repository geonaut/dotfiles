{{ if eq .chezmoi.osRelease.id "ubuntu" -}}
#!/bin/bash

# run_onchange_before_install-ubuntu-dependencies.sh.tmpl
# This script runs early to fix repositories and install core tools.

set -e

echo "üîß Starting Ubuntu dependency bootstrap..."

# 1. Fix Repositories (Handles the 'Oracular' vs 'Noble' issue we saw)
# Only run this if we are in a Live CD environment to avoid messing with 
# a permanent installation's custom mirrors.
if [ "$(whoami)" = "ubuntu" ]; then
    echo "üìç Live environment detected. Checking repository codenames..."
    CODENAME=$(lsb_release -cs)
    sudo sed -i "s/oracular/$CODENAME/g" /etc/apt/sources.list.d/ubuntu.sources || true
    sudo sed -i "s/jammy/$CODENAME/g" /etc/apt/sources.list.d/ubuntu.sources || true
fi

# 2. Update package lists
sudo apt update

# 3. Install Core Dependencies
# - python3-setuptools: Fixes 'thefuck' on Ubuntu 24.04 (Python 3.12)
# - curl/git: Basic requirements
# - build-essential: General dev tools
sudo apt install -y \
    curl \
    git \
    python3-setuptools \
    build-essential \
    unzip

{{ if not .is_server -}}
# 4. Desktop-Specific Dependencies (only if is_server is false)
# These are required for Ghostty and other GUI tools
echo "üñ•Ô∏è  Installing Desktop-specific libraries..."
sudo apt install -y \
    libgtk-4-dev \
    libadwaita-1-dev
{{ end -}}

echo "‚úÖ Ubuntu dependencies installed successfully."

{{ end -}}