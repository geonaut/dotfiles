#!/bin/bash
# .user-env hash: {{ include "dot_zshrc.tmpl" | sha256sum }}

set -e

# Define Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RESET='\033[0m'

status() { echo -e "${GREEN}âœ… $1${RESET}"; }
info() { echo -e "${BLUE}â„¹ï¸  $1${RESET}"; }
warn() { echo -e "${YELLOW}âš ï¸  $1${RESET}"; }

# 1. OH MY ZSH & PLUGINS
if [ ! -d "$HOME/.oh-my-zsh" ]; then
    info "Installing Oh My Zsh..."
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended
fi

ZSH_CUSTOM="${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}"
PLUGINS=(
    "https://github.com/zsh-users/zsh-syntax-highlighting.git"
    "https://github.com/zsh-users/zsh-autosuggestions.git"
    "https://github.com/fdellwing/zsh-bat.git"
)

info "Cloning/Updating Zsh plugins..."
for repo in "${PLUGINS[@]}"; do
    name=$(basename "$repo" .git)
    if [ ! -d "$ZSH_CUSTOM/plugins/$name" ]; then
        git clone "$repo" "$ZSH_CUSTOM/plugins/$name"
    fi
done

# 2. STARSHIP PROMPT
if ! command -v starship >/dev/null; then
    info "Installing Starship prompt..."
    curl -sS https://starship.rs/install.sh | sh -s -- -y -b "$HOME/.local/bin"
fi

# 3. DESKTOP SPECIFICS (Fonts and Terminal Config)
{{ if and (eq .chezmoi.os "linux") (not .is_server) -}}
info "Applying Linux Desktop configurations..."
FONT_DIR="$HOME/.local/share/fonts/Hack"
if [ ! -d "$FONT_DIR" ]; then
    info "ðŸ“¦ Installing Hack Nerd Font..."
    mkdir -p "$FONT_DIR"
    TEMP_ZIP="/tmp/Hack.zip"
    curl -fLo "$TEMP_ZIP" "https://github.com/ryanoasis/nerd-fonts/releases/latest/download/Hack.zip"
    unzip -o "$TEMP_ZIP" -d "$FONT_DIR"
    rm "$TEMP_ZIP"
    fc-cache -f "$HOME/.local/share/fonts"
fi

if command -v gsettings >/dev/null 2>&1; then
    info "ðŸŽ¨ Configuring GNOME Terminal font..."
    PROFILE_ID=$(gsettings get org.gnome.Terminal.ProfilesList default | tr -d "'")
    SCHEMA_PATH="org.gnome.Terminal.Legacy.Profile:/org/gnome/terminal/legacy/profiles:/:$PROFILE_ID/"
    gsettings set "$SCHEMA_PATH" font 'Hack Nerd Font Mono 11' || true
    gsettings set "$SCHEMA_PATH" use-custom-font true 2>/dev/null || true
fi
{{- end }}

# 4. MACOS-SPECIFIC SHELL CONFIG (Switch to Homebrew Zsh)
{{ if eq .chezmoi.os "darwin" -}}
info "Ensuring Homebrew Zsh is the default shell..."
BREW_PREFIX="{{ if eq .chezmoi.arch "arm64" }}/opt/homebrew{{ else }}/usr/local{{ end }}"
BREW_ZSH="$BREW_PREFIX/bin/zsh"

if [ -f "$BREW_ZSH" ]; then
    # Use dscl to get the actual login shell setting on macOS
    CURRENT_SHELL=$(dscl . -read "/Users/$USER" UserShell | awk '{print $NF}')
    
    if [ "$CURRENT_SHELL" != "$BREW_ZSH" ]; then
        if ! grep -q "$BREW_ZSH" /etc/shells; then
            info "Adding $BREW_ZSH to /etc/shells (requires sudo)..."
            echo "$BREW_ZSH" | sudo tee -a /etc/shells
        fi
        info "Changing login shell to $BREW_ZSH..."
        chsh -s "$BREW_ZSH"
    fi
fi
{{- end }}


# 5. FINAL PATH CHECK
export PATH="$HOME/.local/bin:$PATH"

status "User environment setup complete!"