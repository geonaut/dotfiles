{{ if eq .chezmoi.os "linux" -}}
#!/bin/bash
set -e

# --- Helper Functions ---
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
RESET='\033[0m'

status() { echo -e "${GREEN}✅ $1${RESET}"; }
info() { echo -e "${BLUE}ℹ️  $1${RESET}"; }
warn() { echo -e "${YELLOW}⚠️  $1${RESET}"; }

info "Starting Linux system bootstrap..."

# 1. UBUNTU SPECIFIC REPO FIXES
{{ if eq .chezmoi.osRelease.id "ubuntu" -}}
if [ "$(whoami)" = "ubuntu" ]; then
    info "Live environment detected. Ensuring repository consistency..."
    CODENAME=$(lsb_release -cs)
    # Target the new 24.04 DEB822 format
    SOURCES_FILE="/etc/apt/sources.list.d/ubuntu.sources"
    if [ -f "$SOURCES_FILE" ]; then
        sudo sed -i "s/oracular/$CODENAME/g" "$SOURCES_FILE" || true
    fi
fi
{{- end }}

# 2. DEFINE PACKAGE LIST
# Add or remove packages here to keep your "Brewfile" style list
PACKAGES=(
    "git"
    "zsh"
    "tmux"
    "htop"
    "curl"
    "wget"
    "jq"
    "fzf"
    "bat"
    "unzip"
    "build-essential"
)

# 3. ADD DESKTOP DEPENDENCIES (if not a server)
{{ if not .is_server -}}
info "Adding desktop-specific libraries to install list..."
PACKAGES+=(
    "libgtk-4-dev"
    "libadwaita-1-dev"
    "fontconfig"
)
{{- end }}

# 4. EXECUTE INSTALLATION
info "Syncing package manager..."
sudo apt-get update

info "Installing packages: ${PACKAGES[*]}"
sudo apt-get install -y "${PACKAGES[@]}"

# 5. SHELL CHANGE (Improved with error handling)
TARGET_ZSH=$(command -v zsh)
USER_NAME=$(whoami)

if [ "$SHELL" != "$TARGET_ZSH" ]; then
    info "Attempting to change default shell to Zsh for $USER_NAME..."
    
    # We check if the user exists in /etc/passwd first
    if grep -q "^${USER_NAME}:" /etc/passwd; then
        # Use || true so if chsh fails for any other reason, the script continues
        sudo chsh -s "$TARGET_ZSH" "$USER_NAME" || warn "chsh failed, skipping..."
    else
        warn "User '$USER_NAME' not found in /etc/passwd. Skipping shell change."
    fi
fi

status "System bootstrap complete."
{{ end -}}