{{ if eq .chezmoi.os "darwin" -}}
export PATH="/opt/homebrew/bin:$PATH"
fpath=(/opt/homebrew/share/zsh/site-functions $fpath)
{{ end -}}

export PATH="$HOME/.local/bin:$PATH"
export ZSH="$HOME/.oh-my-zsh"

# Starship handles the prompt; no OMZ theme needed
ZSH_THEME=""

# Standard OMZ plugins + your custom ones
plugins=(git zsh-autosuggestions zsh-bat kubectl thefuck fzf)

if [ -f "$ZSH/oh-my-zsh.sh" ]; then
    source "$ZSH/oh-my-zsh.sh"
fi

# Uncomment the following line to use case-sensitive completion.
# CASE_SENSITIVE="true"

# Uncomment the following line to use hyphen-insensitive completion.
# Case-sensitive completion must be off. _ and - will be interchangeable.
# HYPHEN_INSENSITIVE="true"

# Uncomment one of the following lines to change the auto-update behavior
# zstyle ':omz:update' mode disabled  # disable automatic updates
zstyle ':omz:update' mode auto      # update automatically without asking
# zstyle ':omz:update' mode reminder  # just remind me to update when it's time

# Uncomment the following line to change how often to auto-update (in days).
# zstyle ':omz:update' frequency 13

# Uncomment the following line if pasting URLs and other text is messed up.
# DISABLE_MAGIC_FUNCTIONS="true"

# Uncomment the following line to disable colors in ls.
# DISABLE_LS_COLORS="true"

# Uncomment the following line to disable auto-setting terminal title.
# DISABLE_AUTO_TITLE="true"

# Uncomment the following line to enable command auto-correction.
ENABLE_CORRECTION="true"

# Would you like to use another custom folder than $ZSH/custom?
# ZSH_CUSTOM=/path/to/new-custom-folder

export LANG=en_GB.UTF-8

# Preferred editor for local and remote sessions
# if [[ -n $SSH_CONNECTION ]]; then
#   export EDITOR='vim'
# else
#   export EDITOR='mvim'
# fi

# Compilation flags
# export ARCHFLAGS="-arch x86_64"

# Set personal aliases, overriding those provided by oh-my-zsh libs,
# plugins, and themes. Aliases can be placed here, though oh-my-zsh
# users are encouraged to define aliases within the ZSH_CUSTOM folder.
# For a full list of active aliases, run `alias`.
#
# Example aliases
# alias zshconfig="mate ~/.zshrc"
# alias ohmyzsh="mate ~/.oh-my-zsh"
# source ~/powerlevel10k/powerlevel10k.zsh-theme

# # To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
# [[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

HISTSIZE=10000
SAVEHIST=10000
setopt HIST_IGNORE_ALL_DUPS  # Don't record the same command twice
setopt SHARE_HISTORY         # Share history between terminal tabs

export FZF_DEFAULT_OPTS="--height 40% --layout=reverse --border --info=inline"

bindkey '^[[A' up-line-or-search
bindkey '^[[B' down-line-or-search

#-- ALIASES --#

# Bazel (NB:the zsh plugin already provides several)
alias bz='bazel'
alias bazel="bazelisk"

# Chezmoi aliases

alias cm='chezmoi'
alias cm_apply='chezmoi apply && source ~/.zshrc'
alias cm_rebuild='chezmoi state delete-bucket --bucket=scriptState && chezmoi apply && source ~/.zshrc'
alias cm_bootstrap_mac='~/.local/share/chezmoi/bootstrap/macos/bootstrap.sh'
alias cm_bootstrap_linux='~/.local/share/chezmoi/bootstrap/ubuntu/bootstrap.sh'

# TheFuck initialization
if command -v thefuck &> /dev/null; then
    eval $(thefuck --alias)
fi

# Ubuntu specific fixes
{{ if eq .chezmoi.os "linux" -}}
# Ubuntu calls 'bat' 'batcat' when installed via apt
if command -v batcat &> /dev/null; then
    alias bat='batcat'
fi
{{ end -}}

# EZA Aliases (Universal - Works on Mac and Linux now)
if command -v eza &> /dev/null; then
    alias ls='eza'
    alias l='eza -l --git --header'
    alias ll='eza -la --git --header'
    alias la='eza -la --git'
    alias lt='eza -latr --header'
    alias lS='eza -lhrS --header'
    alias tree='eza -T -I "node_modules|__pycache__|.git|target"'
fi

### TMUX

go_tmux() {
    local SESSION_NAME="main"

    if ! command -v tmux &> /dev/null; then
        echo "ðŸ›‘ Error: tmux command not found. Please ensure it is installed."
        return 1
    fi

    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        echo "ðŸ—‘ï¸ Found and killing old tmux session '$SESSION_NAME' to create a fresh one..."
        tmux kill-session -t "$SESSION_NAME"
    fi

    echo "ðŸš€ Starting new, fresh tmux session '$SESSION_NAME' with three-pane layout..."
    tmux new-session -d -s "$SESSION_NAME" -n "dev"
    tmux split-window -v -t "$SESSION_NAME"
    tmux select-pane -U
    tmux split-window -h
    tmux select-pane -D
    tmux attach-session -t "$SESSION_NAME"
}

exit_tmux() {
    # 1. Get the name of the current session
    # We use a built-in tmux variable to get the session name safely.
    local CURRENT_SESSION_NAME="$(tmux display-message -p '#S')"

    # 2. Check if we are inside a tmux session and if the name is available
    if [ -n "$TMUX" ] && [ -n "$CURRENT_SESSION_NAME" ]; then
        echo "ðŸ”ª Killing tmux session: $CURRENT_SESSION_NAME"

        # Kill the entire session. This detaches all clients (including your Ghostty window).
        # We wrap this in a sub-shell to ensure the local variables are handled correctly
        # and to prevent errors from crashing the current shell.
        tmux kill-session -t "$CURRENT_SESSION_NAME"
    else
        echo "âš ï¸ Not currently inside a named tmux session."
    fi

    # 3. Exit the current shell process.
    # This closes the Ghostty window/tab if it was the last shell running.
    exit
}

# MAC-ONLY ALIASES

# Navigation
alias go_coding="cd ~/Coding"

# --- STARSHIP INIT ---
# This MUST be at the very end of the file
if command -v starship &> /dev/null; then
    eval "$(starship init zsh)"
fi
