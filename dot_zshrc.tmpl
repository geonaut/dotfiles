[[ -f ~/.profile ]] && . ~/.profile

{{ if eq .chezmoi.os "darwin" -}}
export PATH="/opt/homebrew/bin:$PATH"
fpath=(/opt/homebrew/share/zsh/site-functions $fpath)
{{ end -}}

export PATH="$HOME/.local/bin:$PATH"
export ZSH="$HOME/.oh-my-zsh"

# Starship handles the prompt; no OMZ theme needed
ZSH_THEME=""

# Standard OMZ plugins + your custom ones
plugins=(git zsh-autosuggestions zsh-bat kubectl fzf bazel)

if [ -f "$ZSH/oh-my-zsh.sh" ]; then
    source "$ZSH/oh-my-zsh.sh"
fi

if [ -f "$HOME/.zshrc_local" ]; then
  source "$HOME/.zshrc_local"
fi

# Auto-source .zshrc when it changes
zshrc_mtime=$(stat -f %m ~/.zshrc)
check_zshrc_update() {
  local current_mtime=$(stat -f %m ~/.zshrc)
  if [[ "$current_mtime" != "$zshrc_mtime" ]]; then
    zshrc_mtime=$current_mtime
    source ~/.zshrc
    echo "â™»ï¸  .zshrc changes detected and applied."
  fi
}
# Run this check before every prompt
add-zsh-hook precmd check_zshrc_update

# Uncomment the following line to use case-sensitive completion.
# CASE_SENSITIVE="true"

# Uncomment the following line to use hyphen-insensitive completion.
# Case-sensitive completion must be off. _ and - will be interchangeable.
# HYPHEN_INSENSITIVE="true"

# Uncomment one of the following lines to change the auto-update behavior
# zstyle ':omz:update' mode disabled  # disable automatic updates
zstyle ':omz:update' mode auto      # update automatically without asking
# zstyle ':omz:update' mode reminder  # just remind me to update when it's time

# Uncomment the following line to change how often to auto-update (in days).
# zstyle ':omz:update' frequency 13

# Uncomment the following line if pasting URLs and other text is messed up.
# DISABLE_MAGIC_FUNCTIONS="true"

# Uncomment the following line to disable colors in ls.
# DISABLE_LS_COLORS="true"

# Uncomment the following line to disable auto-setting terminal title.
# DISABLE_AUTO_TITLE="true"

# Uncomment the following line to enable command auto-correction.
ENABLE_CORRECTION="false"

# Would you like to use another custom folder than $ZSH/custom?
# ZSH_CUSTOM=/path/to/new-custom-folder

export LANG=en_GB.UTF-8

# Preferred editor for local and remote sessions
# if [[ -n $SSH_CONNECTION ]]; then
#   export EDITOR='vim'
# else
#   export EDITOR='mvim'
# fi

# Compilation flags
# export ARCHFLAGS="-arch x86_64"

# Set personal aliases, overriding those provided by oh-my-zsh libs,
# plugins, and themes. Aliases can be placed here, though oh-my-zsh
# users are encouraged to define aliases within the ZSH_CUSTOM folder.
# For a full list of active aliases, run `alias`.
#
# Example aliases
# alias zshconfig="mate ~/.zshrc"
# alias ohmyzsh="mate ~/.oh-my-zsh"
# source ~/powerlevel10k/powerlevel10k.zsh-theme

# # To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
# [[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

HISTSIZE=10000
SAVEHIST=10000
setopt HIST_IGNORE_ALL_DUPS  # Don't record the same command twice
setopt SHARE_HISTORY         # Share history between terminal tabs

export FZF_DEFAULT_OPTS="--height 40% --layout=reverse --border --info=inline"

bindkey '^[[A' up-line-or-search
bindkey '^[[B' down-line-or-search

#-- ALIASES --#

# --- Bazel (Core) ---
alias bz='bazel'
alias bazel="bazelisk"
alias bzb='bazel build'
alias bzt='bazel test'
alias bzr='bazel run'
alias bzc='bazel clean'
alias bzce='bazel clean --expunge'

# --- Bzlmod & Dependency Management ---
alias bztidy='bazel mod tidy'
alias bzgraph='bazel mod graph'
alias bzshow='bazel mod show_repo'

# --- Gazelle (The Generator) ---
alias bzg='bazel run //:gazelle --experimental_isolated_extension_usages'
alias bz_sync_go='go mod tidy && bazel mod tidy && bazel run //:gazelle'

alias bz_sync_rust='CARGO_BAZEL_REPIN=1 bazel run //:gazelle --experimental_isolated_extension_usages'

# --- Querying ---
alias bzq='bazel query'
alias bzwho='bazel query --output=label_kind "rdeps(//..., attr(srcs, \!.*, //...))"'
alias bzdeps='bazel query "deps($1)"'

# --- Formatting ---
alias bzf='buildifier -r .'

# --- IDE Support ---
# Helpful for when Rust Analyzer loses track of the crate universe
alias bz_rust_fix='bazel clean && bazel build //... && bz_sync_rust'

# Chezmoi aliases

alias cm='chezmoi'
alias cma='cm_apply'
alias cm_apply='chezmoi apply && exec zsh'
alias cm_rebuild='chezmoi state delete-bucket --bucket=scriptState && chezmoi apply && exec zsh'
alias cm_bootstrap_mac='~/.local/share/chezmoi/bootstrap/macos/bootstrap.sh'
alias cm_bootstrap_linux='~/.local/share/chezmoi/bootstrap/ubuntu/bootstrap.sh'
alias cm_rerun_questions='rm ~/.config/chezmoi/chezmoi.toml && chezmoi init && chezmoi apply'
alias cm_ask_new_questions='chezmoi init && chezmoi apply'
alias cm_edit='cd ~/.local/share/chezmoi'

# Ubuntu specific fixes
{{ if eq .chezmoi.os "linux" -}}
# Ubuntu calls 'bat' 'batcat' when installed via apt
if command -v batcat &> /dev/null; then
    alias bat='batcat'
fi
{{ end -}}

# EZA Aliases (Universal - Works on Mac and Linux now)
if command -v eza &> /dev/null; then
    alias ls='eza'
    alias l='eza -l --git --header'
    alias ll='eza -la --git --header'
    alias la='eza -la --git'
    alias lt='eza -latr --header'
    alias lS='eza -lhrS --header'
    alias tree='eza -T -I "node_modules|__pycache__|.git|target"'
fi

### GIT (also see .gitconfig)

alias git_whoami='git config user.email && git config user.name'

### TMUX

go_tmux() {
    local SESSION_NAME="main"

    if ! command -v tmux &> /dev/null; then
        echo "ðŸ›‘ Error: tmux command not found. Please ensure it is installed."
        return 1
    fi

    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        echo "ðŸ—‘ï¸ Found and killing old tmux session '$SESSION_NAME' to create a fresh one..."
        tmux kill-session -t "$SESSION_NAME"
    fi

    echo "ðŸš€ Starting new, fresh tmux session '$SESSION_NAME' with three-pane layout..."
    tmux new-session -d -s "$SESSION_NAME" -n "dev"
    tmux split-window -v -t "$SESSION_NAME"
    tmux select-pane -U
    tmux split-window -h
    tmux select-pane -D
    tmux attach-session -t "$SESSION_NAME"
}

exit_tmux() {
    # 1. Get the name of the current session
    # We use a built-in tmux variable to get the session name safely.
    local CURRENT_SESSION_NAME="$(tmux display-message -p '#S')"

    # 2. Check if we are inside a tmux session and if the name is available
    if [ -n "$TMUX" ] && [ -n "$CURRENT_SESSION_NAME" ]; then
        echo "ðŸ”ª Killing tmux session: $CURRENT_SESSION_NAME"

        # Kill the entire session. This detaches all clients (including your Ghostty window).
        # We wrap this in a sub-shell to ensure the local variables are handled correctly
        # and to prevent errors from crashing the current shell.
        tmux kill-session -t "$CURRENT_SESSION_NAME"
    else
        echo "âš ï¸ Not currently inside a named tmux session."
    fi

    # 3. Exit the current shell process.
    # This closes the Ghostty window/tab if it was the last shell running.
    exit
}

context() {
    # Define colors
    local bold="\033[1m"
    local green="\033[32m"
    local blue="\033[34m"
    local cyan="\033[36m"
    local yellow="\033[33m"
    local dim="\033[2m"
    local reset="\033[0m"

    echo -e "${bold}System & Cloud Contexts${reset}"
    echo -e "--------------------------------------------------------------------------------"

    (
        # Header for the table
        echo -e "${bold}SERVICE\tACTIVE_CONTEXT/INFO${reset}"

        # 1. Kubernetes Context
        if command -v kubectl &> /dev/null; then
            local k_ctx=$(kubectl config current-context 2>/dev/null || echo "None")
            echo -e "Kubernetes\t${blue}${k_ctx}${reset}"
        fi

        # 2. AWS Profile
        if [[ -n "$AWS_PROFILE" ]]; then
            echo -e "AWS Profile\t${yellow}${AWS_PROFILE}${reset}"
        elif [[ -f ~/.aws/config ]]; then
            local a_ctx=$(grep "\[profile" ~/.aws/config | head -1 | awk '{print $2}' | tr -d ']')
            echo -e "AWS (Config)\t${a_ctx:-default}"
        fi

        # 3. GCloud Account
        if command -v gcloud &> /dev/null; then
            local g_ctx=$(gcloud config get-value account 2>/dev/null)
            echo -e "GCloud\t${cyan}${g_ctx:-None}${reset}"
        fi

        # 4. Git Identity
        local g_email=$(git config user.email 2>/dev/null)
        echo -e "Git Email\t${g_email:-Not Set}"

        # 5. Language Versions
        if command -v pyenv &> /dev/null; then
            local p_ver=$(pyenv version-name 2>/dev/null)
            echo -e "Python\t${green}pyenv: ${p_ver}${reset}"
        fi

        if command -v goenv &> /dev/null; then
            local g_ver=$(goenv version-name 2>/dev/null)
            echo -e "Go\t${cyan}goenv: ${g_ver}${reset}"
        fi

    ) | column -t -s $'\t'

    # 6. Prettified PATH
    echo -e "\n${bold}Active PATH:${reset}"
    # Splitting PATH by colon and printing with index
    echo $PATH | tr ':' '\n' | awk '{print "  "NR". " $0}' | sed "s|$HOME|~|g"

    # 7. Brew Packages (Single line list)
    if command -v brew &> /dev/null; then
        echo -e "\n${bold}Brew Packages (On-Request):${reset}"
        local b_list=$(brew list --installed-on-request | paste -sd ", " -)
        echo -e "${dim}${b_list}${reset}" | fold -s -w $(tput cols)
    fi

    echo -e "--------------------------------------------------------------------------------"
}

# MAC-ONLY ALIASES

# Navigation
alias go_coding="cd ~/Coding"

# --- STARSHIP INIT ---
# This MUST be at the very end of the file
if command -v starship &> /dev/null; then
    eval "$(starship init zsh)"
fi
