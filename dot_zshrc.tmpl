[[ -f ~/.profile ]] && . ~/.profile

{{ if eq .chezmoi.os "darwin" -}}
export PATH="/opt/homebrew/bin:$PATH"
fpath=(/opt/homebrew/share/zsh/site-functions $fpath)
{{ end -}}

export PATH="$HOME/.local/bin:$PATH"
export ZSH="$HOME/.oh-my-zsh"

# Starship handles the prompt; no OMZ theme needed
ZSH_THEME=""

# Standard OMZ plugins + your custom ones
plugins=(git zsh-autosuggestions zsh-bat kubectl fzf bazel)

if [ -f "$ZSH/oh-my-zsh.sh" ]; then
    source "$ZSH/oh-my-zsh.sh"
fi

# Load local overrides (like git_clean_branches)
if [ -f "$HOME/.zshrc_local" ]; then
  source "$HOME/.zshrc_local"
fi

# Load local overrides (like git_clean_branches)
if [ -f "$HOME/.zshrc_helpers" ]; then
  source "$HOME/.zshrc_helpers"
fi

# Load local overrides (like git_clean_branches)
if [ -f "$HOME/.zshrc_bazel" ]; then
  source "$HOME/.zshrc_bazel"
fi


# Auto-source .zshrc when it changes
zshrc_mtime=$(stat -f %m ~/.zshrc)
check_zshrc_update() {
  local current_mtime=$(stat -f %m ~/.zshrc)
  if [[ "$current_mtime" != "$zshrc_mtime" ]]; then
    zshrc_mtime=$current_mtime
    source ~/.zshrc
    echo "♻️  .zshrc changes detected and applied."
  fi
}
# Run this check before every prompt
add-zsh-hook precmd check_zshrc_update

# --- OMZ Settings ---
zstyle ':omz:update' mode auto      # update automatically without asking
ENABLE_CORRECTION="false"
export LANG=en_GB.UTF-8

HISTSIZE=10000
SAVEHIST=10000
setopt HIST_IGNORE_ALL_DUPS  # Don't record the same command twice
setopt SHARE_HISTORY         # Share history between terminal tabs

export FZF_DEFAULT_OPTS="--height 40% --layout=reverse --border --info=inline"

bindkey '^[[A' up-line-or-search
bindkey '^[[B' down-line-or-search

#-- ALIASES --#

# --- Chezmoi ---
alias cm='chezmoi'
alias cma='cm_apply'
alias cm_apply='chezmoi apply && source ~/.zshrc'
alias cm_rebuild='chezmoi state delete-bucket --bucket=scriptState && chezmoi apply && source ~/.zshrc'
alias cm_bootstrap_mac='~/.local/share/chezmoi/bootstrap/macos/bootstrap.sh'
alias cm_bootstrap_linux='~/.local/share/chezmoi/bootstrap/ubuntu/bootstrap.sh'
alias cm_rerun_questions='rm ~/.config/chezmoi/chezmoi.toml && chezmoi init && chezmoi apply'
alias cm_ask_new_questions='chezmoi init && chezmoi apply'
alias cm_edit='cd ~/.local/share/chezmoi'

# --- OS Specifics ---
{{ if eq .chezmoi.os "linux" -}}
# Ubuntu calls 'bat' 'batcat' when installed via apt
if command -v batcat &> /dev/null; then
    alias bat='batcat'
fi
{{ end -}}

# --- Modern CLI Tools ---
if command -v eza &> /dev/null; then
    alias ls='eza'
    alias l='eza -l --git --header'
    alias ll='eza -la --git --header'
    alias la='eza -la --git'
    alias lt='eza -latr --header'
    alias tree='eza -T -I "node_modules|__pycache__|.git|target"'
fi

# --- Git Extras ---
alias git_whoami='git config user.email && git config user.name'
alias git_rebase='git fetch origin main:main && git rebase main --autostash'



# --- Starship Init ---
if command -v starship &> /dev/null; then
    eval "$(starship init zsh)"
fi